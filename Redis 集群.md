# Redis 集群 

redis的集群方案可以归纳为三种：1、主从复制；2、哨兵集群（Redis Sentinel）3、分片集群（Redis Cluster）

除此之外，还可以使用 第三方方案，比如使用一些第三方工具 ，如 Twemproxy 、Codis等

## 一、主从复制

一主多从，主节点负责写操作，并将数据复制到从节点上。从节点接收主节点的复制，并可以处理读操作

## 二、哨兵集群

### 什么是Sentinel?

Sentinel（哨兵）是一个内置组件，sentinel监控redis主节点和从节点的状态，在主节点故障时自动进行故障转移，使系统能够继续工作，而无需手动干预。

### Sentinel的主要功能？

1. 监控：定期检查 主节点和从节点的状态。通过发送心跳和执行命令来确认节点是否可达，并检查节点是否可以正常运行
2. 故障检测：当发现主节点不可用时，它会自动启动故障转移过程。Sentinel 会选举一个从节点提升为新的主节点，并通知其他 Sentinel 和 Redis 客户端进行更新。
3. 故障转移：Sentinel 负责协调故障转移过程。它会通知其他 Sentinel 和 Redis 客户端关于主节点变更的信息，并引导它们将请求发送到新的主节点。
4. 配置提供：entinel 在启动时会将自己的配置信息广播给其他 Sentinel，以便形成一个 Sentinel 集群。这样可以确保 Sentinel 集群中的所有节点都具有相同的视图和配置信息。

### Sentinel 如何检测节点是否下线 ？主观下线与客观下线的区别？

1. 主观下线（Subjectively Down）：哨兵节点期间会向所有主节点和从节点发送 PING 命令，如果在指定的时间内没有收到 PONG 相应，哨兵节点会认为将该节点比较为主观下线。

2. 客观下线（Objectively Down）：如果一个主节点被多数哨兵节点标记为主观下线，那么它将被标记为客观下线。

主观下线是每个 Sentinel 独立进行的判断，而客观下线是 Sentinels 之间通过投票和共识达成的判断。

当节点被标记为客观下线后，Sentinel 将触发故障转移过程，并选举新的主节点。客观下线的判断是基于多个 Sentinel 的共识，以减少误判和错误的故障转移操作。

### Sentinel 如何故障转移的 ？

1、检测主节点状态：sentinel会定期检查 redis 主节点的状态。如果发现主节点不可达或宕机，他会将主节点标记为下线状态

2、选举新的主节点：

- sentinel 通过互相通信，达成共识并选举一个sentinel负责执行故障转移操作
- 选举负责的Sentinel 会执行故障转移操作，并将选出的新主节点的信息广播给其他的sentinel 和 redis 客户端

3、故障转移工作：

- 新主节点选择完成后，Sentinel 会将新主节点的信息广播给其他 Sentinel 和 Redis 客户端。这样，其他 Sentinel 和客户端就知道了新的主节点的地址和端口。
- Sentinel 向新主节点发送 SLAVEOF NO ONE 命令，将新主节点从从节点转变为独立的主节点。
- 其他从节点收到新主节点的信息后，会更新自己的配置，将新主节点设置为自己的主节点，并重新与新主节点建立连接。

4、更新客户端配置：在故障转移完成后，应用程序的客户端需要更新连接信息，将新的主节点的地址和端口配置为目标，以便与新的主节点进行通信。

### 为什么建议部署多个 sentinel 节点（哨兵集群）

1. 部署多个 Sentinel 节点，可以提供哨兵集群的高可用性。
2. 共识机制：通过多个 Sentinel 节点的共同决策，可以减少误判和错误的故障转移操作。
3. 故障转移的-可靠性：多个 Sentinel 节点可以提供更可靠的故障转移过程。多个 Sentinel 节点之间会协同工作，选举新的主节点并通知其他节点和客户端进行更新。
4. 配置的一致性：通过部署多个 Sentinel 节点，并使用相同的配置信息，可以确保整个哨兵集群中的所有节点具有相同的视图和一致的配置。

### Sentinel 如何选举出新的 master（选举机制）？

1. 哨兵发现主节点不可用：每个 Sentinel 都会独立地监控 Redis 节点的状态。当 Sentinel 发现主节点不可达或宕机时，它将主节点标记为下线状态。
2. 主观下线阶段：在主观下线阶段，每个 Sentinel 将自己的观察结果发送给其他 Sentinel，并进行投票。Sentinel 需要达到一定的票数才能将主节点标记为主观下线。
3. 客观下线阶段：在客观下线阶段，Sentinel 之间进行通信，并共享关于节点状态的信息。Sentinel 通过投票和共识机制，来判断节点是否达到客观下线状态。如果更多的 Sentinel 将节点标记为主观下线，并达成共识，那么节点将被标记为客观下线。
4. 选举新的主节点：一旦主节点被标记为客观下线，Sentinel 开始选举新的主节点。选举过程主要包括以下步骤：
   - Sentinels 之间通过互相通信，达成共识并选举出一个 Sentinel 负责执行故障转移操作。
   - 选举负责的 Sentinel 会执行故障转移操作，并将选出的新主节点的信息广播给其他 Sentinel 和 Redis 客户端。
5. 故障转移过程：在故障转移过程中，新的主节点被选举出来，并将其他从节点设置为新主节点的从节点。Sentinel 向新主节点发送 SLAVEOF NO ONE 命令，将其从从节点转变为独立的主节点。其他从节点收到新主节点的信息后，会更新自己的配置，将新主节点设置为自己的主节点，并重新与新主节点建立连接。

### 如何从 Sentinel 集群中选择出 Leader ？

Redis Sentinel 集群中没有显示的 Leader 节点。他们都进行故障检测、故障转移和监控任务

在 Sentienl 集群中，每个 Sentinel 节点都会独立监控 Redis主节点的状态，并根据自己的观察结果参与投票和共识过程。当主节点被标记为客观下线时，Sentinel 集群会进行故障转移并选举出新的主节点。

在故障转移期间，Sentinel 节点之间会进行通信，共同决策并选举出一个 Sentinel 节点来执行故障转移操作。这个被选中的 Sentinel 节点负责执行故障转移的任务，包括选举新的主节点、通知其他节点和客户端等。

该被选中的 Sentinel 节点并不是固定的 Leader，而是在每次故障转移时动态选举的。其他 Sentinel 节点会协作并达成共识，选择出一个适当的 Sentinel 节点来执行故障转移操作。

### Sentinel 可以防止脑裂吗？

脑裂是指在分布式系统中，网络分区或通信故障导致集群中的节点无法相互通信，从而导致不一致的状态和冲突的操作。

无法完全防止脑裂

引入 Qorum（仲裁） 机制：处理网络分区和脑裂的情况。Qorum 机制要求在执行故障转移之前，必须有足够数量的 Sentinel 节点能够互相通信，达成共识并形成一个有效的多数派。以此来防止脑裂

Sentinel 使用 Redis 的持久化机制来确保故障转移过程的可靠性。通过将重要的状态信息和配置信息持久化到磁盘上，并在节点重新启动后加载，可以防止脑裂导致的数据丢失和状态不一致。

## 三、分片集群

### 1、为什么需要 Redis Cluster ？ 解决了什么问题 ？有什么优势？

优势：解决传统单节点 Redis 在扩展性和高可用性方面的限制；通过数据分布、故障转移、自动发现和一致性协议等机制，提供了更高的性能、更好的可靠性和更好的扩展性，使得 Redis 能够应对大规模和高并发的应用场景。

### 2、怎样进行分片

将数据按照某种规则 （key 的hash值）分配到不同的节点上。当客户端想要访问某个 key 时，会先计算出这个 key   存储在哪个节点，然后直接连接到该节点进行操作。

**在Redis的Cluster 集群模式中，使用哈希槽（hash slot）的方式来进行数据分片** 想要存储数据时，一般通过获取 key 的hash值，然后对 hash槽的数量（16384）进行取模 找到对应的 分片进行操作
